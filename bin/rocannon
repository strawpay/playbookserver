#!/bin/bash

# Deploy via Rocannon

usage() {
cat <<EOF

$0 [-c cert ] [-a ca-cert ] [-u url]  -p | -f version-file | -v version [ -i refId ] inventory playbook 

Where:
inventory     the inventory, "master" is mapped to test
playbook      a playbook without extension .yaml stored in git@bitbucket.org:strawpay/playbooks.git

Option

-a ca-certfile      use ca-cert-file as cacert
-c cert-file        use cert-file as cert
-f version-file     version-file for version
-v version          use { "version":"$version"} as version
-i refId            use refId as refId
-u url              url to rocannon server, defaults to https://rocannon.strawpay.com  
-p                  ping, ie. access $url/ping

EOF
exit 1
}

cert=""
cacert=""
refId=""
url=https://rocannon.strawpay.com

while getopts "a:c:f:i:v:u:p" opt; do
    case $opt in
	a)
	    cacert="--cacert $OPTARG"
	    ;;
	c)
	    cert="--cert $OPTARG"
	    ;;
	f)
	    version="-d @$OPTARG"
	    ;;
	v)
	    version="-d {\"version\":\"$OPTARG\"}"
	    ;;
	i)
	    refId="?refId=$OPTARG"
	    ;;
	u)
	    url=$OPTARG
	    ;;
	p)
	    ping=true
	    ;;
	*)
	    echo "Unknown option $OPTARG"
	    usage
    esac
done

shift $(($OPTIND-1))

if [ $ping ]; then
    path=ping
elif [ $# -ne 2 -o -z "$version" ]; then
    usage;
else
    # Map branch to inventory
    case $1 in
	master) inv=test ;;
	develop) inv=dev ;;
	*) inv=$1 ;;
    esac
    
    play=${2}.yaml
    path=$inv/$play$refId
    method="-X POST"
    headers="-H Content-Type:application/json"
fi

curl -s -S  -f $method $headers $cacert $cert $version $url/$path
